# API Документация для онлайн-магазина

## Описание
API для управления заказами в онлайн-магазине. Система позволяет просматривать каталог товаров, создавать заказы с резервированием товаров и подтверждать заказы с списанием средств с баланса пользователя.

## Эндпоинты

### 1. GET /api/catalog
Получение списка всех доступных товаров.

**Ответ:**
```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "name": "Товар 1",
            "description": "Описание товара",
            "price": "100.00",
            "stock": 50
        }
    ]
}
```

### 2. POST /api/create-order
Создание нового заказа с резервированием товаров.

**Тело запроса:**
```json
{
    "user_id": 1,
    "items": [
        {
            "product_id": 1,
            "quantity": 2
        },
        {
            "product_id": 3,
            "quantity": 1
        }
    ]
}
```

**Ответ:**
```json
{
    "success": true,
    "message": "Заказ успешно создан",
    "data": {
        "order_id": 1,
        "order_number": "ORD-1234567890",
        "total_price": 250.00,
        "status": "draft"
    }
}
```

**Ошибки:**
- `400` - Недостаточно товара на складе
- `422` - Ошибка валидации данных
- `500` - Внутренняя ошибка сервера

### 3. POST /api/approve-order/
Подтверждение заказа и списание средств с баланса пользователя.

**Тело запроса:**
Content-Type: application/json
```json
{
    "order_id": 4
}
```


**Ответ:**
```json
{
    "success": true,
    "message": "Заказ успешно подтвержден",
    "data": {
        "order_id": 1,
        "order_number": "ORD-1234567890",
        "total_paid": 250.00,
        "new_balance": 4750.00,
        "status": "approved"
    }
}
```

**Ошибки:**
- `400` - Заказ уже подтвержден/отменен или недостаточно средств
- `500` - Внутренняя ошибка сервера

## Модели данных

### User (Пользователь)
- `id` - ID пользователя
- `name` - Имя пользователя
- `email` - Email пользователя
- `balance` - Баланс средств
- `created_at`, `updated_at` - Временные метки

### Product (Товар)
- `id` - ID товара
- `name` - Наименование товара
- `description` - Описание товара
- `price` - Цена товара
- `stock` - Количество на складе
- `created_at`, `updated_at` - Временные метки

### Order (Заказ)
- `id` - ID заказа
- `number` - Номер заказа (уникальный)
- `status` - Статус заказа (draft, approved, cancelled)
- `user_id` - ID пользователя
- `created_at`, `updated_at` - Временные метки

### OrderItem (Элемент заказа)
- `id` - ID элемента заказа
- `order_id` - ID заказа
- `product_id` - ID товара
- `quantity` - Количество товара
- `price` - Зафиксированная цена товара на момент заказа
- `created_at`, `updated_at` - Временные метки

## Установка и запуск

1. Установите зависимости:
```bash
composer install
```

2. Настройте подключение к базе данных в файле `.env`

3. Запустите миграции:
```bash
php artisan migrate
```

4. Заполните базу данных тестовыми данными:
```bash
php artisan db:seed
```

5. Запустите сервер разработки:
```bash
php artisan serve
```

## Тестирование API

### Пример создания заказа с помощью curl:

```bash
# Получение каталога товаров
curl -X GET http://localhost:8000/api/catalog

# Создание заказа
curl -X POST http://localhost:8000/api/create-order \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "items": [
      {"product_id": 1, "quantity": 2},
      {"product_id": 3, "quantity": 1}
    ]
  }'

# Подтверждение заказа
curl -X POST http://localhost:8000/api/approve-order/1
```

## Особенности реализации

1. **Резервирование товаров**: При создании заказа товары автоматически резервируются (уменьшается количество на складе)
2. **Фиксация цен**: Цены товаров фиксируются на момент создания заказа в таблице `order_items`
3. **Транзакционность**: Все операции с заказами выполняются в транзакциях для обеспечения целостности данных
4. **Валидация**: Проверка наличия товаров на складе и достаточности средств на балансе
5. **Безопасность**: Использование транзакций предотвращает частичное выполнение операций 
